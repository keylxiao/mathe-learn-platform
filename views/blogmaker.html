<!DOCTYPE html>
<html lang="en">

<head>
    <title>博文编辑</title>
    <meta http-equiv="Content-Type" content="text/html;charset=gbk" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="./css/public.css" />
    <link rel="stylesheet" href="./css/login.css" />
        <script src="./js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="./js/jquery.validata.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="gbk" src="ueditor.config.js"></script>
    <script type="text/javascript" charset="gbk" src="ueditor.all.min.js"> </script>
    <script type="text/javascript" charset="gbk" src="lang/zh-cn/zh-cn.js"></script>

    <style type="text/css">
        div {
            width: 100%;
        }
    </style>
</head>

<body>
    <div>
        <h1>博文编辑</h1>
        <input type="text" name="page_name" placeholder="博文名称" id="page_name">
        <input type="text" name="brief_intro" placeholder="博文简介" id="brief_intro">
        <script id="editor" type="text/plain" style="width:1024px;height:500px;"></script>
    </div>
    <div id="btns">
        <div>
            <button id="enable" onclick="setEnabled()">可以编辑</button>
            <button onclick="setDisabled()">不可编辑</button>
            <button onclick=" UE.getEditor('editor').setHide()">隐藏编辑器</button>
            <button onclick=" UE.getEditor('editor').setShow()">显示编辑器</button>
            <button onclick="createEditor()">创建编辑器</button>
            <button onclick="deleteEditor()">删除编辑器</button>
            <button id="onload">博客上传</button>
        </div>
    </div>

    <script type="text/javascript">
        // 获取地址栏参数
        function getQueryStringRegExp(name) {
            var reg = new RegExp("(^|\\\?|&)" + name + "=(\[^&\]*)(\\\s|&|$)", "i");
            if (reg.test(location.href)) return unescape(RegExp.$2.replace(/\\+/g, " ")); return "";
        }
        //实例化编辑器
        //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
        var ue = UE.getEditor('editor');

        function createEditor() {
            enableBtn();
            UE.getEditor('editor');
        }

        function setDisabled() {
            UE.getEditor('editor').setDisabled('fullscreen');
            disableBtn("enable");
        }

        function setEnabled() {
            UE.getEditor('editor').setEnabled();
            enableBtn();
        }
        function deleteEditor() {
            disableBtn();
            UE.getEditor('editor').destroy();
        }
        function disableBtn(str) {
            var div = document.getElementById('btns');
            var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
            for (var i = 0, btn; btn = btns[i++];) {
                if (btn.id == str) {
                    UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
                } else {
                    btn.setAttribute("disabled", "true");
                }
            }
        }
        function enableBtn() {
            var div = document.getElementById('btns');
            var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
            for (var i = 0, btn; btn = btns[i++];) {
                UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
            }
        }
        $('#onload').click(function () {
            var id = getQueryStringRegExp("id")
            var name = $('#page_name').val().toString()
            var brief = $('#brief_intro').val().toString()
            var data = JSON.stringify({
                "UserId": id,
                "BlogName": name,
                "BriefIntro": brief,
                "State": 0
            })
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://127.0.0.1:8001/Blog/OnloadBlogInf');
            xhr.setRequestHeader("Content-type", "application/json");
            xhr.send(data);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 500) {
                        alert("服务器错误, 请稍后再试！")
                    } else {
                        var blogid = JSON.parse(xhr.responseText)
                        var body = UE.getEditor('editor').getContent();
                        var bodys = JSON.stringify({
                            "BlogId": blogid,
                            "Body": body
                        })
                        var ajax = new XMLHttpRequest();
                        ajax.open('POST', 'http://127.0.0.1:8001/Blog/OnloadBlogBody');
                        ajax.setRequestHeader("Content-type", "application/json");
                        ajax.send(bodys);
                        ajax.onreadystatechange = function () {
                            if (ajax.readyState === 4) {
                                if (ajax.status === 500) {
                                    alert("服务器错误, 请稍后再试！")
                                } else {
                                    alert("上传成功! ")
                                }
                            }
                        }
                    }
                }
            }
        })
    </script>
</body>

</html>